<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Метрики - Календарь релизов ИД "Инженерия Данных"</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="all" href="../static/styles/style.css" th:href="@{/styles/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="d-flex flex-column min-vh-100">
<nav class="navbar navbar-expand-lg navbar-light sticky-top">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">Главная</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/books">Книги</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/authors">Авторы</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/series">Серии</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/genres">Жанры</a>
                </li>
                <li class="nav-item" sec:authorize="hasAnyRole('ADMIN')">
                    <a class="nav-link" href="/users">Пользователи</a>
                </li>
                <li class="nav-item" sec:authorize="hasAnyRole('MANAGER', 'ADMIN')">
                    <a class="nav-link" href="/metrics">Метрики</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" sec:authorize="!hasAnyRole('USER', 'EDITOR', 'ADMIN', 'MANAGER')" href="/login">Вход</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" sec:authorize="hasAnyRole('USER', 'EDITOR', 'ADMIN', 'MANAGER')" href="/profile">Личный профиль</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" sec:authorize="!hasAnyRole('USER', 'EDITOR', 'ADMIN', 'MANAGER')" href="/register">Регистрация</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" sec:authorize="hasAnyRole('USER', 'EDITOR', 'ADMIN', 'MANAGER')" href="/logout">Выход</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<main class="container flex-grow-1 py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card view-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                        <h1 class="h2 mb-0">Метрики списка желаний</h1>
                    </div>
                    
                    <div class="d-flex flex-column gap-4">
                        <!-- Authors Chart -->
                        <div class="metrics-chart-section">
                            <h2 class="h5 mb-3 pb-2 border-bottom">Топ авторов в списках желаний</h2>
                            <div class="chart-container">
                                <canvas id="authorsChart"></canvas>
                            </div>
                        </div>

                        <!-- Genres Chart -->
                        <div class="metrics-chart-section">
                            <h2 class="h5 mb-3 pb-2 border-bottom">Топ жанров в списках желаний</h2>
                            <div class="chart-container">
                                <canvas id="genresChart"></canvas>
                            </div>
                        </div>

                        <!-- Timeline Chart -->
                        <div class="metrics-chart-section">
                            <h2 class="h5 mb-3 pb-2 border-bottom">Добавления в список желаний по датам</h2>
                            <div class="chart-container">
                                <canvas id="timelineChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="footer mt-auto">
    <div class="container-fluid d-flex justify-content-center align-items-center flex-wrap gap-3">
        <a href="/about">О создателе</a>
        <a href="/contacts">Контакты</a>
    </div>
</footer>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Authors Chart
        const authorsCtx = document.getElementById('authorsChart');
        if (authorsCtx) {
            const authorLabels = /*[[${authorLabels}]]*/ [];
            const authorCounts = /*[[${authorCounts}]]*/ [];
            
            console.log('Author Labels:', authorLabels);
            console.log('Author Counts:', authorCounts);
            
            if (authorLabels.length > 0 && authorCounts.length > 0) {
                new Chart(authorsCtx, {
                    type: 'bar',
                    data: {
                        labels: authorLabels,
                        datasets: [{
                            label: 'Количество добавлений',
                            data: authorCounts,
                            backgroundColor: 'rgba(76, 175, 80, 0.6)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } else {
                authorsCtx.parentElement.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Нет данных для отображения</p>';
            }
        }

        // Genres Chart
        const genresCtx = document.getElementById('genresChart');
        if (genresCtx) {
            const genreLabels = /*[[${genreLabels}]]*/ [];
            const genreCounts = /*[[${genreCounts}]]*/ [];
            
            console.log('Genre Labels:', genreLabels);
            console.log('Genre Counts:', genreCounts);
            
            if (genreLabels.length > 0 && genreCounts.length > 0) {
                new Chart(genresCtx, {
                    type: 'doughnut',
                    data: {
                        labels: genreLabels,
                        datasets: [{
                            label: 'Количество добавлений',
                            data: genreCounts,
                            backgroundColor: [
                                'rgba(76, 175, 80, 0.8)',
                                'rgba(33, 150, 243, 0.8)',
                                'rgba(255, 152, 0, 0.8)',
                                'rgba(156, 39, 176, 0.8)',
                                'rgba(244, 67, 54, 0.8)',
                                'rgba(0, 188, 212, 0.8)',
                                'rgba(255, 87, 34, 0.8)',
                                'rgba(121, 85, 72, 0.8)',
                                'rgba(63, 81, 181, 0.8)',
                                'rgba(139, 195, 74, 0.8)'
                            ],
                            borderColor: [
                                'rgba(76, 175, 80, 1)',
                                'rgba(33, 150, 243, 1)',
                                'rgba(255, 152, 0, 1)',
                                'rgba(156, 39, 176, 1)',
                                'rgba(244, 67, 54, 1)',
                                'rgba(0, 188, 212, 1)',
                                'rgba(255, 87, 34, 1)',
                                'rgba(121, 85, 72, 1)',
                                'rgba(63, 81, 181, 1)',
                                'rgba(139, 195, 74, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            } else {
                genresCtx.parentElement.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Нет данных для отображения</p>';
            }
        }

        // Timeline Chart
        const timelineCtx = document.getElementById('timelineChart');
        if (timelineCtx) {
            const timelineLabels = /*[[${timelineLabels}]]*/ [];
            const timelineCounts = /*[[${timelineCounts}]]*/ [];
            
            console.log('Timeline Labels:', timelineLabels);
            console.log('Timeline Counts:', timelineCounts);
            
            if (timelineLabels.length > 0 && timelineCounts.length > 0) {
                new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: timelineLabels,
                        datasets: [{
                            label: 'Добавлений в список желаний',
                            data: timelineCounts,
                            backgroundColor: 'rgba(76, 175, 80, 0.2)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } else {
                timelineCtx.parentElement.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Нет данных для отображения</p>';
            }
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
