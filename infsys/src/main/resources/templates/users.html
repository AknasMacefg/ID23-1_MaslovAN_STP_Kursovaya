<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ru">
<head>
    <title>Календарь релизов ИД "Инженерия Данных"</title>
    <link rel="stylesheet" type="text/css" media="all" href="../static/styles/style.css" th:href="@{/styles/style.css}">
</head>
<body>
<header class="header__nav">
    <nav class="nav__list">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <ul class="header__list" id="headerList">
            <li>
                <a href="/">
                    Главная
                </a>
            </li>
            <li>
                <a href="/books">
                    Книги
                </a>
            </li>
            <li>
                <a href="/authors">
                    Авторы
                </a>
            </li>
            <li>
                <a href="/series">
                    Серии
                </a>
            </li>
            <li>
                <a href="/genres">
                    Жанры
                </a>
            </li>
            <li sec:authorize="hasAnyRole('ADMIN')">
                <a  href="/users">
                    Пользователи
                </a>
            </li>
            <li sec:authorize="hasAnyRole('MANAGER', 'ADMIN')">
                <a href="/metrics">
                    Метрики
                </a>
            </li>
            <li sec:authorize="hasAnyRole('ADMIN')">
                <a href="/admin/csv">
                    CSV Управление
                </a>
            </li>
        </ul>
        <ul class="login__nav" id="loginNav">
            <li>
                <a sec:authorize="!hasAnyRole('USER', 'EDITOR', 'ADMIN', 'MANAGER')" href="/login">
                    Вход
                </a>
            </li>
            <li>
                <a sec:authorize="hasAnyRole('USER', 'EDITOR', 'ADMIN', 'MANAGER')" href="/profile">
                    Личный профиль
                </a>
            </li>
            <li>
                <a sec:authorize="!hasAnyRole('USER', 'EDITOR', 'ADMIN', 'MANAGER')" href="/register">
                    Регистрация
                </a>
            </li>
            <li>
                <a sec:authorize="hasAnyRole('USER', 'EDITOR', 'ADMIN', 'MANAGER')" href="/logout">
                    Выход
                </a>
            </li>
        </ul>
    </nav>
</header>

<section class="section_middle">
    <div class="filter-box">
        <form method="get" action="/users" class="filter-form">
            <h3 class="filter-title">Фильтры</h3>
            
            <div class="filter-group">
                <label for="search" class="filter-label">Поиск:</label>
                <input type="text" 
                       name="search" 
                       id="search" 
                       class="filter-input" 
                       placeholder="Логин, email..."
                       th:value="${searchQuery}">
            </div>
            
            <div class="filter-group">
                <label for="role" class="filter-label">Роль:</label>
                <select name="role" id="role" class="filter-select">
                    <option value="">-- Все роли --</option>
                    <option th:each="role : ${allRoles}" 
                            th:value="${role}" 
                            th:text="${role}"
                            th:selected="${selectedRole != null && selectedRole == role.toString()}">
                    </option>
                </select>
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn btn-filter">Применить</button>
                <a href="/users" class="btn btn-filter-reset">Сбросить</a>
            </div>
        </form>
    </div>
    <div class="content-area">
        <div class="page-header">
            <h1>Пользователи</h1>
        </div>
        <div class="form-message form-success" th:if="${success}" th:text="${success}"></div>
        <div class="form-message form-error" th:if="${error}" th:text="${error}"></div>
        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>
                            <a th:href="@{/users(role=${selectedRole != null ? selectedRole : ''}, sortBy=${selectedSortBy == 'username' ? 'username_desc' : 'username'})}" class="sortable-header">
                                Логин
                                <span th:if="${selectedSortBy == 'username'}">↑</span>
                                <span th:if="${selectedSortBy == 'username_desc'}">↓</span>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/users(role=${selectedRole != null ? selectedRole : ''}, sortBy=${selectedSortBy == 'email' ? 'email_desc' : 'email'})}" class="sortable-header">
                                Email
                                <span th:if="${selectedSortBy == 'email'}">↑</span>
                                <span th:if="${selectedSortBy == 'email_desc'}">↓</span>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/users(role=${selectedRole != null ? selectedRole : ''}, sortBy=${selectedSortBy == 'role' ? 'role_desc' : 'role'})}" class="sortable-header">
                                Роль
                                <span th:if="${selectedSortBy == 'role'}">↑</span>
                                <span th:if="${selectedSortBy == 'role_desc'}">↓</span>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/users(role=${selectedRole != null ? selectedRole : ''}, sortBy=${selectedSortBy == 'created_at' ? 'created_at_desc' : 'created_at'})}" class="sortable-header">
                                Время создания
                                <span th:if="${selectedSortBy == 'created_at'}">↑</span>
                                <span th:if="${selectedSortBy == 'created_at_desc'}">↓</span>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/users(role=${selectedRole != null ? selectedRole : ''}, sortBy=${selectedSortBy == 'updated_at' ? 'updated_at_desc' : 'updated_at'})}" class="sortable-header">
                                Время изменения
                                <span th:if="${selectedSortBy == 'updated_at'}">↑</span>
                                <span th:if="${selectedSortBy == 'updated_at_desc'}">↓</span>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/users(role=${selectedRole != null ? selectedRole : ''}, sortBy=${selectedSortBy == 'log_in_at' ? 'log_in_at_desc' : 'log_in_at'})}" class="sortable-header">
                                Время входа
                                <span th:if="${selectedSortBy == 'log_in_at'}">↑</span>
                                <span th:if="${selectedSortBy == 'log_in_at_desc'}">↓</span>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/users(role=${selectedRole != null ? selectedRole : ''}, sortBy=${selectedSortBy == 'logout_at' ? 'logout_at_desc' : 'logout_at'})}" class="sortable-header">
                                Время выхода
                                <span th:if="${selectedSortBy == 'logout_at'}">↑</span>
                                <span th:if="${selectedSortBy == 'logout_at_desc'}">↓</span>
                            </a>
                        </th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="user : ${users}">
                        <td th:text="${user.username}"></td>
                        <td th:text="${user.email}"></td>
                        <td>
                            <span class="role-badge" th:text="${user.role}"></span>
                        </td>
                        <td th:text="${user.created_at != null ? #temporals.format(user.created_at, 'dd.MM.yyyy HH:mm') : '-'}"></td>
                        <td th:text="${user.updated_at != null ? #temporals.format(user.updated_at, 'dd.MM.yyyy HH:mm') : '-'}"></td>
                        <td th:text="${user.log_in_at != null ? #temporals.format(user.log_in_at, 'dd.MM.yyyy HH:mm') : '-'}"></td>
                        <td th:text="${user.logout_at != null ? #temporals.format(user.logout_at, 'dd.MM.yyyy HH:mm') : '-'}"></td>
                        <td>
                            <a class="btn btn-edit-small" th:href="@{/users/edit/{id}(id=${user.id})}">Изменить</a>
                            <a class="btn btn-delete-small" 
                               th:href="@{/users/delete/{id}(id=${user.id})}"
                               onclick="return confirm('Вы уверены, что хотите удалить пользователя? Все записи в списке желаний этого пользователя будут удалены.');">Удалить</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>
<footer class="footer">
    <a class="footer-links" href="/about">
        О создателе
    </a>
    <a class="footer-links" href="/contacts">
        Контакты
    </a>
</footer>
</body>
</html>